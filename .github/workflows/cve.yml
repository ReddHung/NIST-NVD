name: Daily Chromium Docker Redis CVE Alert

on:
  schedule:
    # 台灣 UTC+8 → 每天 09:00 = UTC 01:00
    - cron: "0 1 * * *"
  workflow_dispatch:

jobs:
  cve_alert:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        pip install requests

    - name: Run CVE script
      env:
        API_KEY: ${{ secrets.API_KEY }}
      run: |
        python cve.py Chromium Docker Redis > cve_output.txt

    - name: Show result
      run: cat cve_output.txt

    - name: Check if CVE result is empty
      id: check_output
      run: |
        if grep -q "CVE-" cve_output.txt; then
          echo "found=true" >> $GITHUB_OUTPUT
        else
          echo "found=false" >> $GITHUB_OUTPUT
        fi
        cat $GITHUB_OUTPUT

    - name: Send email via SendGrid
      if: steps.check_output.outputs.found == 'true'
      uses: actions/github-script@v7
      env:
        SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
        EMAIL_USER: ${{ secrets.RECIPIENT }}      
      with:
        script: |
          const fs = require('fs');
          const content = fs.readFileSync('cve_output.txt', 'utf8');
          
          const response = await fetch("https://api.sendgrid.com/v3/mail/send", {
            method: "POST",
            headers: {
              "Authorization": `Bearer ${process.env.SENDGRID_API_KEY}`,
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              personalizations: [{ 
                to: [{ email: process.env.EMAIL_USER }] 
              }],
              from: { email: process.env.EMAIL_USER },
              subject: "NIST NVD CVE Report",
              content: [{ type: "text/plain", value: content }]
            })
          });
          
          if (!response.ok) {
            const error = await response.text();
            throw new Error(`SendGrid API error: ${response.status} - ${error}`);
          }
          
          console.log('Email sent successfully');
